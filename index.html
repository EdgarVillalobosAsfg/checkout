<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta de Recursos</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
        }
        #logo {
            width: 200px;
            margin-top: 20px;
        }
        table {
            width: 90%;
            margin: 20px auto;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid black;
            padding: 8px;
        }
        #exportButtons {
            margin: 20px;
        }
    </style>
</head>
<body>
    <img id="logo" src="https://cmsv2-assets.apptegy.net/uploads/15550/logo/16746/logo_template_300.png" alt="American School Foundation of Guadalajara">
    
    <h2>Consulta de Recursos</h2>

    <div id="welcomeMessage">
        <h3>Bienvenido, por favor ingresa tu Nombre o Employee ID para consultar tus recursos asignados.</h3>
    </div>

    <!-- BÃºsqueda en Tiempo Real -->
    <form id="searchForm">
        <label for="searchInput">Ingresa tu Nombre o Employee ID:</label>
        <input type="text" id="searchInput">
    </form>

    <!-- BotÃ³n de ExportaciÃ³n a CSV -->
    <div id="exportButtons" style="display:none;">
        <button id="exportCSV">ðŸ“¥ Exportar a CSV</button>
    </div>

    <div id="data"></div>

    <script>
        var allData = []; 
        var hiddenColumns = ["Check-out Date", "Email", "Employee ID", "Name"];

        $(document).ready(function() {
            fetchData();

            // BÃºsqueda en tiempo real al escribir en el campo de bÃºsqueda
            $("#searchInput").on("keyup", function() {
                searchLive();
            });

            $("#exportCSV").click(function() {
                exportToCSV();
            });
        });

        function fetchData() {
            $.getJSON("https://script.google.com/macros/s/AKfycbycHQ06-Zf6U9yvvycOo7iL7C4SzM0pbMl4_WUQx94OsxrQW0_qnkdjRsghEpdLBvAfWw/exec", function(data) {
                console.log("Datos cargados desde la API:", data);
                allData = data;
                displayTable(allData);
            }).fail(function() {
                $("#data").html("<p style='color:red;'>Error al cargar los datos desde la API.</p>");
            });
        }

        function searchLive() {
            var searchValue = $("#searchInput").val().trim().toLowerCase();

            var filteredData = allData.filter(function(item) {
                var name = item["Name"] ? item["Name"].toLowerCase() : "";
                var employeeID = item["Employee ID"] ? item["Employee ID"].toLowerCase() : "";
                return name.includes(searchValue) || employeeID.includes(searchValue);
            });

            if (filteredData.length > 0) {
                displayTable(filteredData);
                $("#exportButtons").show(); 
            } else {
                $("#data").html("<p style='color:red;'>No se encontraron recursos asignados.</p>");
                $("#exportButtons").hide();
            }
        }

        function displayTable(data) {
            var headers = Object.keys(data[0]).map(header => header.trim());
            headers = headers.filter(header => !hiddenColumns.includes(header));

            if (headers.includes("Assigned to")) {
                headers = headers.filter(h => h !== "Assigned to");
                headers.unshift("Assigned to"); 
            }

            var table = "<table id='dataTable'><thead><tr>";

            $.each(headers, function(index, header) {
                table += "<th>" + header + "</th>";
            });

            table += "</tr></thead><tbody>";

            $.each(data, function(key, value) {
                table += "<tr>";
                $.each(headers, function(index, header) {
                    var cellData = value[header] || "";
                    
                    if (header.toLowerCase() === "asset photo" && cellData.startsWith("http")) {
                        table += "<td><img src='" + cellData + "' width='100' height='100'></td>";
                    } else {
                        table += "<td>" + cellData + "</td>";
                    }
                });
                table += "</tr>";
            });

            table += "</tbody></table>";
            $("#data").html(table);
        }

        function exportToCSV() {
            var table = document.getElementById("dataTable");
            var csv = [];
            for (var i = 0; i < table.rows.length; i++) {
                var row = [], cols = table.rows[i].cells;
                for (var j = 0; j < cols.length; j++)
                    row.push(cols[j].innerText);
                csv.push(row.join(","));
            }
            var csvFile = new Blob([csv.join("\n")], { type: "text/csv" });
            saveAs(csvFile, "Recursos_Asignados.csv");
        }
    </script>
</body>
</html>
