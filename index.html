<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta de Recursos</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
        }
        #logo {
            width: 200px;
            margin-top: 20px;
        }
        table {
            width: 90%;
            margin: 20px auto;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid black;
            padding: 8px;
        }
    </style>
    <script>
        var allData = []; 
        var hiddenColumns = ["Check-out Date", "Email", "Employee ID", "Name"]; 

        $(document).ready(function() {
            $.getJSON("https://script.google.com/macros/s/AKfycbycHQ06-Zf6U9yvvycOo7iL7C4SzM0pbMl4_WUQx94OsxrQW0_qnkdjRsghEpdLBvAfWw/exec", function(data) {
                console.log("Datos cargados desde la API:", data);
                allData = data;
                $("#welcomeMessage").show();
            }).fail(function() {
                $("#data").html("<p style='color:red;'>Error al cargar los datos desde la API.</p>");
            });

            $("#searchForm").submit(function(event) {
                event.preventDefault();
                var searchValue = $("#searchInput").val().trim().toLowerCase();
                console.log("Valor ingresado en la búsqueda:", searchValue);

                if (searchValue === "") {
                    alert("Por favor ingresa tu Nombre o Employee ID.");
                    return;
                }

                var filteredData = allData.filter(function(item) {
                    console.log("Analizando item:", item);
                    var name = item["Name"] ? item["Name"].toLowerCase() : "";
                    var employeeID = item["Employee ID"] ? item["Employee ID"].toLowerCase() : "";
                    
                    return name.includes(searchValue) || employeeID.includes(searchValue);
                });

                console.log("Resultados encontrados:", filteredData);

                if (filteredData.length > 0) {
                    displayTable(filteredData);
                    $("#welcomeMessage").hide();
                } else {
                    $("#data").html("<p style='color:red;'>No se encontraron recursos asignados. Verifica que el nombre o ID estén bien escritos.</p>");
                }
            });
        });

        function displayTable(data) {
            // Convertir nombres de columnas a un formato sin espacios extra
            var headers = Object.keys(data[0]).map(header => header.trim());
            
            // Eliminar las columnas ocultas
            headers = headers.filter(header => !hiddenColumns.includes(header));

            // Asegurar que "Assigned to" sea la primera columna si existe
            if (headers.includes("Assigned to")) {
                headers = headers.filter(h => h !== "Assigned to");
                headers.unshift("Assigned to"); 
            }

            var table = "<table><thead><tr>";

            $.each(headers, function(index, header) {
                table += "<th>" + header + "</th>";
            });

            table += "</tr></thead><tbody>";

            $.each(data, function(key, value) {
                table += "<tr>";
                $.each(headers, function(index, header) {
                    var cellData = value[header] || "";
                    
                    if (header.toLowerCase() === "asset photo" && cellData.startsWith("http")) {
                        table += "<td><img src='" + cellData + "' width='100' height='100'></td>";
                    } else {
                        table += "<td>" + cellData + "</td>";
                    }
                });
                table += "</tr>";
            });

            table += "</tbody></table>";
            $("#data").html(table);
        }
    </script>
</head>
<body>
    <img id="logo" src="https://cmsv2-assets.apptegy.net/uploads/15550/logo/16746/logo_template_300.png" alt="American School Foundation of Guadalajara">

    <h2>Consulta de Recursos</h2>

    <div id="welcomeMessage" style="display:none;">
        <h3>Bienvenido, por favor ingresa tu Nombre o Employee ID para consultar tus recursos asignados.</h3>
    </div>

    <form id="searchForm">
        <label for="searchInput">Ingresa tu Nombre o Employee ID:</label>
        <input type="text" id="searchInput" required>
        <button type="submit">Buscar</button>
    </form>

    <div id="data"></div>
</body>
</html>
