<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta de Recursos</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
    <style>
        body {
            font-family: 'Arial', sans-serif;
            text-align: center;
            background-color: #f4f4f4;
            color: #333;
        }
        #container {
            width: 90%;
            margin: auto;
            background: white;
            padding: 20px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }
        #logo {
            width: 200px;
            margin-top: 10px;
        }
        table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
            background-color: white;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
        }
        th {
            background-color: #007bff;
            color: white;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            margin: 10px;
            cursor: pointer;
            border-radius: 5px;
            font-size: 16px;
        }
        button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <div id="container">
        <img id="logo" src="https://cmsv2-assets.apptegy.net/uploads/15550/logo/16746/logo_template_300.png" alt="American School Foundation of Guadalajara">
        
        <h2>Consulta de Recursos</h2>

        <div id="welcomeMessage">
            <h3>Bienvenido, por favor ingresa tu Nombre o Employee ID para consultar tus recursos asignados.</h3>
        </div>

        <!-- BÃºsqueda -->
        <form id="searchForm">
            <label for="searchInput">Ingresa tu Nombre o Employee ID:</label>
            <input type="text" id="searchInput" required>
            <button type="submit">Buscar</button>
        </form>

        <!-- Botones de ExportaciÃ³n -->
        <div id="exportButtons" style="display:none;">
            <button id="exportCSV">ðŸ“¥ Exportar a CSV</button>
            <button id="exportPDF">ðŸ“„ Exportar a PDF</button>
        </div>

        <div id="data"></div>
    </div>

    <script>
        var allData = []; 
        var hiddenColumns = ["Check-out Date", "Email", "Employee ID", "Name"];

        $(document).ready(function() {
            fetchData();

            $("#searchForm").submit(function(event) {
                event.preventDefault();
                searchUser();
            });

            $("#exportCSV").click(function() {
                exportToCSV();
            });

            $("#exportPDF").click(function() {
                exportToPDF();
            });
        });

        function fetchData() {
            $.getJSON("https://script.google.com/macros/s/AKfycbycHQ06-Zf6U9yvvycOo7iL7C4SzM0pbMl4_WUQx94OsxrQW0_qnkdjRsghEpdLBvAfWw/exec", function(data) {
                allData = data;
                $("#welcomeMessage").show();
            }).fail(function() {
                $("#data").html("<p style='color:red;'>Error al cargar los datos desde la API.</p>");
            });
        }

        function searchUser() {
            var searchValue = $("#searchInput").val().trim().toLowerCase();

            var filteredData = allData.filter(function(item) {
                var name = item["Name"] ? item["Name"].toLowerCase() : "";
                var employeeID = item["Employee ID"] ? item["Employee ID"].toLowerCase() : "";
                return name.includes(searchValue) || employeeID.includes(searchValue);
            });

            if (filteredData.length > 0) {
                displayTable(filteredData);
                $("#exportButtons").show(); 
            } else {
                $("#data").html("<p style='color:red;'>No se encontraron recursos asignados.</p>");
                $("#exportButtons").hide();
            }
        }

        function displayTable(data) {
            var headers = Object.keys(data[0]).map(header => header.trim());
            headers = headers.filter(header => !hiddenColumns.includes(header));

            if (headers.includes("Assigned to")) {
                headers = headers.filter(h => h !== "Assigned to");
                headers.unshift("Assigned to"); 
            }

            var table = "<table id='dataTable' class='display'><thead><tr>";

            $.each(headers, function(index, header) {
                table += "<th>" + header + "</th>";
            });

            table += "</tr></thead><tbody>";

            $.each(data, function(key, value) {
                table += "<tr>";
                $.each(headers, function(index, header) {
                    var cellData = value[header] || "";

                    if (header.toLowerCase() === "asset photo" && cellData.startsWith("http")) {
                        table += "<td><img src='" + cellData + "' width='100' height='100'></td>";
                    } else {
                        table += "<td>" + cellData + "</td>";
                    }
                });
                table += "</tr>";
            });

            table += "</tbody></table>";
            $("#data").html(table);

            $('#dataTable').DataTable();
        }

        function exportToCSV() {
            var csv = [];
            $("#dataTable tr").each(function() {
                var row = [];
                $(this).find("td, th").each(function() {
                    row.push($(this).text().trim());
                });
                csv.push(row.join(","));
            });

            var csvFile = new Blob([csv.join("\n")], { type: "text/csv" });
            saveAs(csvFile, "Recursos_Asignados.csv");
        }

        function exportToPDF() {
            var { jsPDF } = window.jspdf;
            var doc = new jsPDF();

            var img = new Image();
            img.src = "https://cmsv2-assets.apptegy.net/uploads/15550/logo/16746/logo_template_300.png";
            doc.addImage(img, 'PNG', 10, 10, 50, 30);

            doc.text("Reporte de Recursos Asignados", 70, 20);
            doc.autoTable({ html: "#dataTable", startY: 50 });
            doc.save("Recursos_Asignados.pdf");
        }
    </script>
</body>
</html>
